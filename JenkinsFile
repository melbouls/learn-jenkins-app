pipeline {
    agent any

    environment {
        NETLIFY_SITE_ID = '231cceee-ea92-47ba-ba42-617cf20d3d7c'
        NETLIFY_AUTH_TOKEN = credentials('jcp')
    }

    stages {
        stage('Build') {
            agent {
                docker {
                    image 'node:18-alpine'
                    reuseNode true
                }
            }
            steps {
                sh '''
                    npm ci || npm install
                    npm run build --if-present || echo "Aucun script build trouvé."
                    ls -la
                '''
            }
        }

        stage('Tests unitaires') {
            agent {
                docker {
                    image 'node:18-alpine'
                    reuseNode true
                }
            }
            steps {
                sh '''
                    if npm run | grep -q test; then
                        npm test || echo "Tests échoués"
                    else
                        echo "Aucun test trouvé"
                    fi
                '''
            }
        }

        stage('Tests E2E') {
            agent {
                docker {
                    image 'mcr.microsoft.com/playwright:v1.39.0-jammy'
                    reuseNode true
                }
            }
            steps {
                sh '''
                    npm install serve
                    npx serve -s build &
                    sleep 10
                    npx playwright test --reporter=html || echo "Tests E2E échoués"
                '''
            }
            post {
                always {
                    publishHTML([
                        allowMissing: true,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'playwright-report',
                        reportFiles: 'index.html',
                        reportName: 'Playwright Report'
                    ])
                }
            }
        }

        stage('Déploiement Netlify') {
            agent {
                docker {
                    image 'node:18-alpine'
                    reuseNode true
                }
            }
            steps {
                sh '''
                    npm install -g netlify-cli
                    netlify status || echo "Impossible de vérifier le statut"
                    netlify deploy --dir=build --site=$NETLIFY_SITE_ID --auth=$NETLIFY_AUTH_TOKEN --prod || echo "Échec du déploiement"
                '''
            }
        }
    }

    post {
        always {
            echo "Pipeline terminé."
        }
    }
}
